pipeline 
{
  agent any
   
  parameters 
  {
    choice(
            choices: ['apply', 'destroy'],
            description: 'Terraform action to apply or destroy',
            name: 'action'
    )
    
    checkboxParameter(name: 'Modules', format: 'JSON',
                pipelineSubmitContent: '{"CheckboxParameter": [{"key": "VPC","value": "vpc"},{"key": "Key-Pair","value": "key-pair"},{"key": "EC2 Instance","value": "ec2"}]}', description: '')
  }
  stages 
  {   
    stage('Checkout') 
    {
        steps {
            git branch: 'master',
                credentialsId: 'my_cred_id',
                url: 'https://github.com/99harshil/AWS-Terraform-infrastructure.git'
            sh "ls"
        }
    }
    stage('apply') 
    {
        when 
	{ 
            expression { params.action == 'apply' }
        }
        steps 
    	{
            	dir('terraform/backend') 
		{
                	withAWS(credentials: '493d0f87-10d7-4be2-9108-f18321145beb', region: 'us-east-1') 
			{
                    		sh 'terraform init -upgrade'
	            		sh 'terraform plan'
                    		sh 'terraform apply -auto-approve'
            		}
		}
		print params['Modules']
            	script
		{
            		def apply_list = ['vpc']
			for (int i = 0; i < apply_list.size(); ++i)  
			{
                		echo "Running Terraform in ${apply_list[i]}"
                		if (${apply_list[i]} == "vpc") 
				{
					sh 'echo "in nested if condition"'
                    			dir(subdir) 
					{
                        			sh 'terraform init -upgrade'
                        			sh 'terraform plan -target="module.vpc.aws_vpc.vpc" -target="module.vpc.aws_subnet.public_subnet" -target="module.vpc.aws_subnet.private_subnet" -out=tfplan'
                        			sh 'terraform apply tfplan -auto-approve'
						sh 'terraform plan -out=tfplan2'
						sh 'terraform apply tfplan2 -auto-approve'
                    			}	
                		}			
                		else 
				{
                           		sh 'echo "Running Terraform in other dub-directory"'
                    		}
            		}
          	}
       	}
    }
  }
}
